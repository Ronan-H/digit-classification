<!doctype html>

<html lang="en">
    <head>
            <link rel="stylesheet" href="static/style.css">
            <meta charset="utf-8"/>
            <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
            <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

            <title>Digit Classifier</title>
    </head>

    <body onload="init()">
        <div class="container" class="mr-3">
            <div class="row">
                <div class="col-md-9">
                    <h2>Digit classifier</h2>
                </div>
            </div>

            <div class="row">
                <div class="col-md-9">
                    <h4>Draw a digit below to see how the neural network classifies it</h4>
                </div>
            </div>

            <div class="row">
                <div class="col-md-9">
                    <canvas id="digit-canvas" width="200" height="200"></canvas>
                </div>
            </div>

            <div class="row">
                <div class="col-md-9">
                    <button id="clear-button" type="button" onclick="clearCanvas()" class="btn btn-primary">Clear</button>
                </div>
            </div>

            <br />

            <div class="row">
                <div class="col-md-9">
                    <h4>Classification:</h2>
                </div>
            </div>

            <div class="row">
                <div class="col-md-9">
                    <h2 id="classification"></h2>
                </div>
            </div>
        </div>

        <script>
            // adapted from https://stackoverflow.com/a/8398189
            var canvas, ctx;
            var drawing = false;
            var currX = 0,
                currY = 0;
            var prevX = 0,
                prevY = 0;
            var strokeStyle = "black",
                lineWidth = 15,
                halfLineWidth = lineWidth / 2;
            var canvasWidth, canvasHeight;
            
            function init() {
                canvas = document.getElementById('digit-canvas');
                ctx = canvas.getContext("2d");
                canvasWidth = canvas.width;
                canvasHeight = canvas.height;
                ctx.fillStyle = strokeStyle;
                ctx.strokeStyle = strokeStyle;
                ctx.lineWidth = lineWidth;
            
                canvas.addEventListener("mousemove", function (e) {
                    onMouseEvent('move', e)
                }, false);
                canvas.addEventListener("mousedown", function (e) {
                    onMouseEvent('down', e)
                }, false);
                canvas.addEventListener("mouseup", function (e) {
                    onMouseEvent('up', e)
                }, false);
                canvas.addEventListener("mouseout", function (e) {
                    onMouseEvent('out', e)
                }, false);
            }

            function onMouseEvent(res, e) {
                currX = e.clientX - canvas.getBoundingClientRect().left;
                currY = e.clientY - canvas.getBoundingClientRect().top;

                switch (res) {
                    case "down":
                        drawing = true;
                        ctx.moveTo(currX, currY);
                        fillCircle();
                        break;
                    case "up":
                        fillCircle();
                        classify();
                    case "out":
                        drawing = false;
                        break;
                    case "move":
                        if (drawing) {
                            connectLine();
                        }
                        break;
                }
            }

            function connectLine() {
                ctx.lineTo(currX, currY);
                ctx.stroke();
                fillCircle();
            }

            function fillCircle() {
                ctx.beginPath();
                ctx.arc(currX, currY, halfLineWidth, 0, 2 * Math.PI);
                ctx.fill();
                ctx.closePath()
                ctx.beginPath();
                ctx.lineTo(currX, currY);
            }

            function clearCanvas() {
                ctx.clearRect(0, 0, canvasWidth, canvasHeight);
                $("#classification").text("");
            }

            // AJAX stuff
            // https://stackoverflow.com/a/35203184
            function classify() {
                var canvasSize = canvas.width;

                // load canvas data
                var rawCanvasData = ctx.getImageData(0, 0, canvasSize, canvasSize)
                var pixelArr = rawCanvasData.data;

                // compress canvas data (taking advantage of it being black and white)
                // instead of having [w, w, w, w, b, b, w, w, w], use the form [4, 2, 3]
                // as in: 4 white followed by 2 black followed by 3 white pixels

                // threshold for deciding if a pixel is white/black
                var threshold = 200;
                var pixelArrCounts = []
                var on = true;
                if (pixelArr[0] <= threshold) {
                    pixelArrCounts.push(0)
                    on = false;
                }
                var count = 0;

                // canvas data has 4 components (RGBA) per pixel, so take steps of 4 (data is black and white)
                for (var i = 3; i < pixelArr.length; i += 4) {
                    count++;

                    if ((pixelArr[i] > threshold) != on) {
                        // change in pixel colour from the prevoius one, record count
                        pixelArrCounts.push(count);
                        on = !on;
                        count = 0;
                    }
                }

                if(count > 0) {
                    pixelArrCounts.push(count);
                }

                var compressedData = {
                    width: rawCanvasData.width,
                    height: rawCanvasData.height,
                    pixelData: pixelArrCounts
                }

                $.ajax({
                    type: "POST",
                    url: "/classify",
                    data: compressedData,
                    success: function(result) {
                        $("#classification").text(result);
                    },
                    error: function(result) {
                        alert('HTTP error');
                    }
                });
            }
        </script>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    </body>
</html>