<!doctype html>

<html lang="en">
    <head>
        <!-- from bootstrap starter template -->
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <!-- custom stylesheet on top of bootstrap -->
        <link rel="stylesheet" href="static/style.css">

        <title>Digit Classifier</title>
    </head>

    <body onload="init()">
        <div class="container mt-3">
            <div class="row">
                <div class="col-md-9">
                    <h2>Digit classifier</h2>
                </div>
            </div>

            <div class="row">
                <div class="col-md-9">
                    <h4>Draw a digit below to see how the neural network classifies it</h4>
                </div>
            </div>

            <div class="row">
                <div class="col-md-9">
                    <canvas id="digit-canvas" width="200" height="200"></canvas>
                </div>
            </div>

            <div class="row">
                <div class="col-md-9">
                    <button id="clear-button" type="button" onclick="clearCanvas()" class="btn btn-primary">Clear</button>
                </div>
            </div>

            <br />

            <div class="row">
                <div class="col-md-9">
                    <h4>Classification:</h2>
                </div>
            </div>

            <div class="row">
                <div class="col-md-9">
                    <h2 id="classification"></h2>
                </div>
            </div>
        </div>

        <script>
            // adapted from https://stackoverflow.com/a/8398189
            var canvas, ctx;
            // user currently drawing (mouse is down and inside the canvas)
            var drawing = false;
            // current mouse position
            var currX = 0,
                currY = 0;
            // drawing colour and line width
            var drawColour = "black",
                lineWidth = 15;
            
            function init() {
                // initialise canvas
                canvas = document.getElementById('digit-canvas');
                ctx = canvas.getContext("2d");
                ctx.fillStyle = drawColour;
                ctx.strokeStyle = drawColour;
                ctx.lineWidth = lineWidth;
                ctx.lineCap = "round";

                // register mouse event listeners
                canvas.addEventListener("mousedown", function (e) {
                    onMouseEvent("mousedown", e);
                });
                canvas.addEventListener("mouseup", function (e) {
                    onMouseEvent("mouseup", e);
                });
                canvas.addEventListener("mousemove", function (e) {
                    onMouseEvent("mousemove", e);
                });
                canvas.addEventListener("mouseout", function (e) {
                    onMouseEvent("mouseout", e);
                });
            }

            function onMouseEvent(action, e) {
                // update current mouse position based on event vars
                currX = e.clientX - canvas.getBoundingClientRect().left;
                currY = e.clientY - canvas.getBoundingClientRect().top;

                switch (action) {
                    case "mousedown":
                        // start drawing
                        drawing = true;
                        ctx.moveTo(currX, currY);
                        draw();
                        break;
                    case "mouseup":
                    case "mouseout":
                        if (drawing) {
                            drawing = false;
                            // automatically classify canvas on mouse out/up
                            classify();
                        }
                        break;
                    case "mousemove":
                        if (drawing) {
                            // draw a line from where the mouse was to where it is now
                            draw();
                        }
                        break;
                }
            }

            function draw() {
                // connect a rounded line between where the mouse was and where the mouse currently is
                ctx.lineTo(currX, currY);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(currX, currY);
            }

            function clearCanvas() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                // clear classification
                $("#classification").text("");
            }

            // AJAX stuff
            // https://stackoverflow.com/a/35203184
            function classify() {
                // load canvas data
                var rawCanvasData = ctx.getImageData(0, 0, canvas.width, canvas.height)
                var pixelArr = rawCanvasData.data;

                // encode pixel data using run-length encoding
                encodedPixels = toRunLengthEncoding(pixelArr);

                // put together an object representing the encoded canvas data
                var encodedCanvas = {
                    // assuming the canvas dimensions will always be square
                    size: rawCanvasData.width,
                    pixelData: encodedPixels
                }

                // make an AJAX POST request, sending up the canvas data
                // the resulting classification will be displayed to the user as text
                $.post("/classify", encodedCanvas).done(function(result) {
                    $("#classification").text(result);
                });
            }

            function toRunLengthEncoding(pixelArr) {
                // compress pixel data (taking advantage of it only having two values, black or transparent)
                // ie. instead of having [0, 0, 0, 0, 1, 1, 0, 0, 0], use the form [4, 2, 3]
                // as in: 4 transparent pixels followed by 2 black pixels followed by 3 white pixels
                // more info on the run-length encoding: https://en.wikipedia.org/wiki/Run-length_encoding

                var pixelArrCounts = []
                var onBlack = false;
                if (pixelArr[3] > 0) {
                    // starting on a transparent pixel
                    // (starting with "0 transparent pixels" just flips to black)
                    pixelArrCounts.push(0)
                    onBlack = true;
                }

                // count of black/transparent pixels in a row
                var count = 0;
                // canvas data has 4 components (RGBA) per pixel, so take steps of 4
                // to read only alpha values (check: transparent or not transparent pixel)
                for (var i = 3; i < pixelArr.length; i += 4) {
                    count++;

                    if ((pixelArr[i] > 0) != onBlack) {
                        // change in pixel colour from the prevoius one, record count and flip to white/black
                        pixelArrCounts.push(count);
                        onBlack = !onBlack;
                        count = 0;
                    }
                }

                if(count > 0) {
                    // still pixel counts to be recorded after loop
                    pixelArrCounts.push(count);
                }

                return pixelArrCounts;
            }
        </script>

        <!-- from bootstrap starter template -->
        <!-- (jquery slim swapped for full library) -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    </body>
</html>