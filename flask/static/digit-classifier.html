<!DOCTYPE html>

<html>
    <head>
            <meta charset="utf-8"/>
            <link rel="stylesheet" href="static/style.css">
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    </head>

    <body onload="init()">
        <h2>Digit classifier</h2>
        <h4>Draw a digit below to see how the neural network classifies it</h4>

        <canvas id="digit-canvas" width="250" height="250"></canvas>
        <br />
        <input id="clear-button" type="button" value="Clear" onclick="clearCanvas()" />
        <input id="classify-button" type="button" value="Classify" />
        <p id="classification">Classification: (please press Classify)</p>

        <script>
            // adapted from https://stackoverflow.com/a/8398189
            var canvas, ctx;
            var drawing = false;
            var currX = 0,
                currY = 0;
            var prevX = 0,
                prevY = 0;
            var strokeStyle = "black",
                lineWidth = 19,
                halfLineWidth = lineWidth / 2;
            var canvasWidth, canvasHeight;
            
                function init() {
                    canvas = document.getElementById('digit-canvas');
                    ctx = canvas.getContext("2d");
                    canvasWidth = canvas.width;
                    canvasHeight = canvas.height;
                    ctx.fillStyle = strokeStyle;
                    ctx.strokeStyle = strokeStyle;
                    ctx.lineWidth = lineWidth;
                
                    canvas.addEventListener("mousemove", function (e) {
                        onMouseEvent('move', e)
                    }, false);
                    canvas.addEventListener("mousedown", function (e) {
                        onMouseEvent('down', e)
                    }, false);
                    canvas.addEventListener("mouseup", function (e) {
                        onMouseEvent('up', e)
                    }, false);
                    canvas.addEventListener("mouseout", function (e) {
                        onMouseEvent('out', e)
                    }, false);
                }

                function onMouseEvent(res, e) {
                    currX = e.clientX - canvas.offsetLeft;
                    currY = e.clientY - canvas.offsetTop;

                    switch (res) {
                        case "down":
                            drawing = true;
                            ctx.moveTo(currX, currY);
                            fillCircle();
                            break;
                        case "up":
                            fillCircle();
                        case "out":
                            drawing = false;
                            break;
                        case "move":
                            if (drawing) {
                                connectLine();
                            }
                            break;
                    }
                }

                function connectLine() {
                    ctx.lineTo(currX, currY);
                    ctx.stroke();
                    fillCircle();
                }

                function fillCircle() {
                    ctx.beginPath();
                    ctx.arc(currX, currY, halfLineWidth, 0, 2 * Math.PI);
                    ctx.fill();
                    ctx.closePath()
                    ctx.beginPath();
                    ctx.lineTo(currX, currY);
                }

                function clearCanvas() {
                    ctx.clearRect(0, 0, canvasWidth, canvasHeight);
                }

                // AJAX stuff
                // https://stackoverflow.com/a/35203184
                $("#classify-button").click(function (e) {
                    $("#classification").text("Classification: (loading)");

                    var canvasSize = 250;

                    // load canvas data
                    var rawCanvasData = ctx.getImageData(0, 0, canvasSize, canvasSize)
                    // compress canvas data to a more appropriate form
                    var pixelArr = rawCanvasData.data;
                    var pixelArrComp = []

                    for (var i = 3; i < pixelArr.length; i += 4) {
                        // decide if this pixel is "on" or not
                        var pixelBlack = (pixelArr[i] > 200);
                        pixelArrComp.push(pixelBlack)
                    }

                    var compressedData = {
                        width: rawCanvasData.width,
                        height: rawCanvasData.height,
                        pixelData: pixelArrComp
                    }

                    $.ajax({
                        type: "POST",
                        url: "/classify",
                        data: compressedData,
                        success: function(result) {
                            $("#classification").text("Classification: " + result);
                        },
                        error: function(result) {
                            alert('HTTP error');
                        }
                    });
                });
        </script>
    </body>
</html>